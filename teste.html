<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce Simulation - Full Fidelity</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/design-system/2.21.0/styles/salesforce-lightning-design-system.min.css" />
    <style>
        body { background-color: #f3f2f2; height: 100vh; overflow: hidden; font-family: 'Salesforce Sans', Arial, sans-serif; margin: 0; padding: 0; }
        .hidden { display: none !important; }
        
        /* === SISTEMA DE ABAS (Console Style) === */
        .navexDesktopLayoutContainer { display: flex; flex-direction: column; height: 100vh; }
        .slds-global-header_container { background: #0176d3; padding: 0 1rem; height: 48px; display: flex; align-items: center; flex-shrink: 0; }
        .slds-global-header { display: flex; align-items: center; width: 100%; }
        .slds-global-header__logo { width: 32px; height: 32px; margin-right: 1rem; }
        .slds-global-header__logo svg { fill: white; width: 100%; height: 100%; }
        .global-search-input { background: rgba(255,255,255,0.2); border: none; border-radius: 4px; padding: 6px 12px; color: white; width: 300px; }
        .global-search-input::placeholder { color: rgba(255,255,255,0.7); }
        
        /* Tab Bar Principal */
        .console-tabBar { background: #16325c; height: 40px; display: flex; align-items: center; padding: 0 0.5rem; flex-shrink: 0; }
        .slds-context-bar__primary { display: flex; align-items: center; margin-right: 1rem; }
        .slds-context-bar__app-name { color: white; font-weight: 600; font-size: 14px; padding: 0 12px; }
        .app-launcher-trigger { background: none; border: none; color: white; font-size: 18px; cursor: pointer; padding: 8px; }
        .console-tabBarItems { display: flex; list-style: none; margin: 0; padding: 0; height: 100%; align-items: flex-end; }
        .console-tabBarItems .oneConsoleTabItem { display: flex; align-items: center; background: #22405d; border-radius: 4px 4px 0 0; margin-right: 2px; height: 32px; padding: 0 12px; cursor: pointer; }
        .console-tabBarItems .oneConsoleTabItem.slds-is-active { background: white; }
        .console-tabBarItems .oneConsoleTabItem .tabHeader { color: rgba(255,255,255,0.9); text-decoration: none; font-size: 13px; display: flex; align-items: center; }
        .console-tabBarItems .oneConsoleTabItem.slds-is-active .tabHeader { color: #16325c; }
        .console-tabBarItems .oneConsoleTabItem .tab-icon { margin-right: 6px; }
        
        /* Sub-Tabs */
        .slds-sub-tabs { background: #f3f2f2; border-bottom: 1px solid #dddbda; height: 36px; display: flex; align-items: flex-end; padding: 0 0.5rem; flex-shrink: 0; }
        .slds-sub-tabs__nav { display: flex; list-style: none; margin: 0; padding: 0; height: 100%; align-items: flex-end; }
        .slds-sub-tabs__item { display: flex; align-items: center; background: #e0e5ee; border: 1px solid #dddbda; border-bottom: none; border-radius: 4px 4px 0 0; margin-right: 2px; height: 28px; padding: 0 10px; cursor: pointer; position: relative; }
        .slds-sub-tabs__item.slds-is-active { background: white; border-bottom: 2px solid white; margin-bottom: -1px; z-index: 1; }
        .slds-sub-tabs__item .tabHeader { color: #3e3e3c; text-decoration: none; font-size: 12px; display: flex; align-items: center; }
        .slds-sub-tabs__item .subtab-icon { margin-right: 4px; }
        .slds-sub-tabs__item .close-btn { background: none; border: none; color: #706e6b; cursor: pointer; font-size: 14px; margin-left: 8px; padding: 0 2px; border-radius: 2px; line-height: 1; }
        .slds-sub-tabs__item .close-btn:hover { background: #dddbda; }
        
        /* Workspace */
        .workspace-container { flex: 1; overflow: auto; background: #f3f2f2; }
        .loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        #toast-container { position: absolute; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 10000; width: 400px; }
        
        /* Estilos espec√≠ficos para emular a estrutura de registros do Salesforce */
        .slds-form-element__label { color: #3e3e3c; font-size: 0.75rem; padding-right: 0.5rem; margin-bottom: 0.125rem; }
        .test-id__field-value { color: #080707; font-size: 0.8125rem; min-height: 1.25rem; display: block; }
        .slds-border_bottom { border-bottom: 1px solid #dddbda; }
        .section-header-title { font-weight: 700; font-size: 1rem; line-height: 1.25; }
        .slds-table_header-fixed_container { height: calc(100vh - 320px); overflow: auto; background: white; }
        
        /* UI Input Select (Modal) */
        .uiInputSelect .uiPopupTrigger a.select { display: block; border: 1px solid #dddbda; border-radius: .25rem; background: white; padding: 0 1rem 0 .75rem; line-height: 1.875rem; min-height: calc(1.875rem + 2px); color: #181818; text-decoration: none; position: relative; }
        .uiInputSelect .uiPopupTrigger a.select:after { content: ""; position: absolute; top: 50%; right: .75rem; transform: translateY(-50%); border-top: 4px solid black; border-left: 4px solid transparent; border-right: 4px solid transparent; }
        .uiMenuList { display: none; background: white; border: 1px solid #dddbda; border-radius: .25rem; position: absolute; width: 100%; z-index: 9002; margin-top: 2px; max-height: 200px; overflow-y: auto; box-shadow: 0 2px 3px 0 rgba(0,0,0,.16); }
        .uiMenuList.visible { display: block; }
        .uiMenuList li a { display: block; padding: .5rem .75rem; color: #181818; text-decoration: none; font-size: 0.8125rem; }
        .uiMenuList li a:hover { background-color: #f3f2f2; }
        .modal-backdrop { position: fixed; top: 0; right: 0; bottom: 0; left: 0; background: rgba(8, 7, 7, 0.6); z-index: 9000; display: flex; align-items: center; justify-content: center; }
        .required { color: rgb(194, 57, 52); margin-left: 0.125rem; }
        
        /* === SISTEMA DE AUTENTICA√á√ÉO === */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #0176d3 0%, #005fb2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }
        
        .login-box {
            background: white;
            padding: 2.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            width: 400px;
            text-align: center;
        }
        
        .login-box .slds-icon {
            fill: #0176d3;
        }
        
        .login-box h1 {
            color: #0176d3;
            margin-top: 1rem;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .login-box .slds-form-element {
            text-align: left;
        }
        
        .login-box .slds-form-element__label {
            font-weight: 600;
            color: #3e3e3c;
        }
        
        .login-box .slds-input {
            width: 100%;
        }
        
        .app-content {
            display: none;
        }
        
        .app-content.authenticated {
            display: block;
        }
    </style>
</head>
<body>

    <div id="login-screen" class="login-container hidden">
        <div class="login-box">
            <div class="slds-m-bottom_medium">
                <svg class="slds-icon" style="width: 48px; height: 48px;" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                </svg>
                <h1>Salesforce Simulation</h1>
                <p class="slds-text-body_small slds-text-color_weak slds-m-top_x-small">Teste de Autentica√ß√£o</p>
            </div>
            <form id="login-form" class="slds-form">
                <div class="slds-form-element">
                    <label class="slds-form-element__label" for="login-username">Usu√°rio</label>
                    <div class="slds-form-element__control">
                        <input type="text" id="login-username" class="slds-input" placeholder="admin" value="admin" required autocomplete="username">
                    </div>
                </div>
                <div class="slds-form-element slds-m-top_small">
                    <label class="slds-form-element__label" for="login-password">Senha</label>
                    <div class="slds-form-element__control">
                        <input type="password" id="login-password" class="slds-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="123456" required autocomplete="current-password">
                    </div>
                </div>
                <div id="login-error" class="slds-text-color_error slds-m-top_x-small hidden"></div>
                <button type="submit" class="slds-button slds-button_brand slds-m-top_medium" style="width: 100%;">
                    <span class="slds-text-body_regular">Entrar</span>
                </button>
            </form>
            <div class="slds-m-top_medium slds-text-body_small slds-text-color_weak">
                <p>Credenciais de teste:</p>
                <p><strong>Usu√°rio:</strong> admin | <strong>Senha:</strong> 123456</p>
            </div>
        </div>
    </div>

    <div id="loading-spinner" class="loading-container hidden">
        <div role="status" class="slds-spinner slds-spinner_medium slds-spinner_brand">
            <span class="slds-assistive-text">Carregando</span>
            <div class="slds-spinner__dot-a"></div>
            <div class="slds-spinner__dot-b"></div>
        </div>
    </div>

    <div id="toast-container"></div>

    <div id="modal-discard" class="modal-backdrop hidden">
        <div class="modal-container slds-modal__container">
            <div class="modal-header slds-modal__header">
                <button type="button" class="slds-button slds-button_icon slds-modal__close closeIcon slds-button_icon-bare" onclick="closeModal()">
                    <lightning-primitive-icon variant="bare"><svg class="slds-button__icon slds-button__icon_large" aria-hidden="true"><use xlink:href="https://cdnjs.cloudflare.com/ajax/libs/design-system/2.21.0/icons/utility-sprite/svg/symbols.svg#close"></use></svg></lightning-primitive-icon>
                    <span class="slds-assistive-text">Cancelar e fechar</span>
                </button>
                <h2 class="slds-modal__title slds-hyphenate">Descartar</h2>
            </div>
            <div class="modal-body scrollable slds-modal__content slds-p-around_medium">
                <div class="forceChatterPublisherPresentationPanel">
                    <div class="container activeState">
                        <div class="container EDIT forceQuickActionLayout">
                            <div class="slds-form form-horizontal">
                                <div class="slds-grid slds-gutters_small forcePageBlockSectionRow">
                                    <div class="slds-col slds-grid slds-has-flexi-truncate forcePageBlockItem">
                                        <div class="slds-form-element slds-form-element_readonly">
                                            <span class="test-id__field-label">Status</span>
                                            <div class="slds-form-element__control"><span class="test-id__field-value slds-form-element__static">Novo</span></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="slds-grid slds-gutters_small forcePageBlockSectionRow slds-m-top_small">
                                    <div class="slds-col slds-has-flexi-truncate forcePageBlockItem">
                                        <div class="slds-form-element">
                                            <div class="slds-form-element__control">
                                                <div class="uiInput uiInputSelect forceInputPicklist">
                                                    <span class="label inputLabel uiPicklistLabel-left form-element__label"><span>Motivo do descarte</span><span class="required">*</span></span>
                                                    <div class="uiMenu">
                                                        <div class="uiPopupTrigger">
                                                            <div><a class="select" aria-required="true" aria-haspopup="true" href="javascript:void(0);" role="combobox" onclick="toggleDropdown('discard-list')" id="discard-trigger">-- Nenhum --</a></div>
                                                        </div>
                                                        <div class="uiMenuList" id="discard-list">
                                                            <ul role="presentation" class="scrollable">
                                                                <li role="presentation"><a href="javascript:void(0);" role="menuitemradio" onclick="selectOption('discard-trigger', 'discard-list', 'N√£o possui mais interesse em se tornar AAI')">N√£o possui mais interesse em se tornar AAI</a></li>
                                                                <li role="presentation"><a href="javascript:void(0);" role="menuitemradio" onclick="selectOption('discard-trigger', 'discard-list', 'Dados Incorretos')">Dados Incorretos</a></li>
                                                                <li role="presentation"><a href="javascript:void(0);" role="menuitemradio" onclick="selectOption('discard-trigger', 'discard-list', 'Sem resposta')">Sem resposta</a></li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="slds-modal__footer">
                <button class="slds-button slds-button_neutral" onclick="closeModal()" aria-label="Cancelar e fechar modal">Cancelar</button>
                <button class="slds-button slds-button_brand uiButton cuf-publisherShareButton" onclick="saveDiscard()" data-action-name="modal.save" aria-label="Salvar descarte"><span dir="ltr" class=" label bBody">Salvar</span></button>
            </footer>
        </div>
    </div>

    <div class="navexDesktopLayoutContainer app-content">
        <header class="slds-global-header_container">
            <div class="slds-global-header">
                <div class="slds-global-header__logo">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path fill="white" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                    </svg>
                </div>
                <input type="search" class="global-search-input" placeholder="Pesquisar no Salesforce...">
                <button onclick="logout()" class="slds-button slds-button_neutral" style="margin-left: auto; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;" title="Sair">
                    <svg style="width: 16px; height: 16px; fill: white; vertical-align: middle; margin-right: 4px;" viewBox="0 0 24 24">
                        <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                    </svg>
                    Sair
                </button>
            </div>
        </header>
        
        <nav class="console-tabBar">
            <div class="slds-context-bar__primary">
                <button class="app-launcher-trigger" title="App Launcher">‚ãÆ‚ãÆ‚ãÆ</button>
                <span class="slds-context-bar__app-name">Matcher</span>
            </div>
            <ul class="console-tabBarItems" role="tablist">
                <li class="oneConsoleTabItem slds-is-active" data-tab-id="leads">
                    <a class="tabHeader" href="javascript:void(0);" role="tab">
                        <span class="tab-icon">
                            <svg class="slds-icon slds-icon_x-small" aria-hidden="true" style="width: 16px; height: 16px; fill: currentColor;">
                                <use xlink:href="https://cdnjs.cloudflare.com/ajax/libs/design-system/2.21.0/icons/utility-sprite/svg/symbols.svg#people"></use>
                            </svg>
                        </span>
                        <span class="title">Meus Leads</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <div class="slds-sub-tabs" role="tablist" id="sub-tabs-container">
            <ul class="slds-sub-tabs__nav" id="sub-tab-list">
            <li class="slds-sub-tabs__item slds-is-active" data-tab-id="list">
                    <a class="tabHeader" href="javascript:void(0);" role="tab" onclick="switchToList()">
                        <span class="subtab-icon">
                            <svg class="slds-icon slds-icon_x-small" aria-hidden="true" style="width: 14px; height: 14px; fill: currentColor;">
                                <use xlink:href="https://cdnjs.cloudflare.com/ajax/libs/design-system/2.21.0/icons/utility-sprite/svg/symbols.svg#list"></use>
                            </svg>
                        </span>
                        <span class="title">SL-9093 | Solicita√ß√£o de Lead</span>
                    </a>
                </li>
            </ul>
        </div>
        
        <div class="workspace-container">
            <div id="brandBand_3" class="slds-brand-band slds-brand-band_cover slds-brand-band_medium slds-template_default">
        
    <div id="view-list" class="slds-template__container">
            <div class="slds-page-header slds-page-header_joined slds-page-header_bleed">
                <div class="slds-grid">
                    <div class="slds-media slds-no-space slds-grow">
                        <div class="slds-media__figure"><span class="slds-icon_container slds-icon-standard-lead" style="background-color: #f77e75"><svg class="slds-icon slds-icon_large" aria-hidden="true"><use xlink:href="https://cdnjs.cloudflare.com/ajax/libs/design-system/2.21.0/icons/standard-sprite/svg/symbols.svg#lead"></use></svg></span></div>
                        <div class="slds-media__body">
                            <h1 class="slds-page-header__title slds-truncate" title="Indica√ß√£o de Leads">Indica√ß√£o de Leads</h1>
                            <p class="slds-text-body--small">150 itens ‚Ä¢ Atualizado agora</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="listViewContainer">
                <div class="slds-table_header-fixed_container">
                    <div class="slds-scrollable_y">
                        <table class="slds-table slds-table_header-fixed slds-table_bordered slds-table_edit slds-table_resizable-cols" role="grid" aria-label="Lista de Leads" aria-rowcount="150">
                            <thead>
                                <tr class="slds-line-height_reset">
                                    <th scope="col" style="width: 50px;"><div class="slds-cell-fixed">#</div></th>
                                    <th scope="col"><div class="slds-cell-fixed" title="Meus Leads">Meus Leads</div></th>
                                    <th scope="col"><div class="slds-cell-fixed" title="Nome do candidato">Nome do candidato</div></th>
                                    <th scope="col"><div class="slds-cell-fixed" title="Status">Status</div></th>
                                    <th scope="col"><div class="slds-cell-fixed" title="Localiza√ß√£o">Localiza√ß√£o</div></th>
                                </tr>
                            </thead>
                            <tbody id="list-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-detail" class="hidden oneRecordHomeFlexipage2Wrapper">
            <div class="record-page-decorator">
                <records-lwc-highlights-panel>
                    <div class="highlights slds-clearfix slds-page-header slds-page-header_record-home">
                        <div class="slds-grid primaryFieldRow">
                            <div class="slds-media slds-no-space">
                                <div class="highlights-icon-container slds-avatar slds-m-right_small icon" style="background-color: #f77e75"><img src="" alt="Lead Icon"></div>
                            </div>
                            <div class="slds-media__body">
                                <h1>
                                    <div class="entityNameTitle">Meu Lead</div>
                                    <div class="slds-page-header__title slds-m-right--small slds-align-middle clip-text" id="header-lead-id">LI-000000</div>
                                </h1>
                            </div>
                            <div class="slds-col slds-no-flex slds-grid slds-grid_vertical-align-center actionsContainer">
                                <runtime_platform_actions-actions-ribbon>
                                    <ul class="slds-button-group-list">
                                        <li class="visible"><button class="slds-button slds-button_neutral" onclick="simulateNetwork('Pretendo Contratar')" data-action-name="LeadIndication__c.intendToHire" aria-label="Marcar como Pretendo Contratar">Pretendo Contratar</button></li>
                                        <li class="visible"><button class="slds-button slds-button_neutral" name="LeadIndication__c.discardRecords" onclick="openDiscardModal()" data-action-name="LeadIndication__c.discard" aria-label="Descartar Lead">Descartar</button></li>
                                        <li class="visible"><button class="slds-button slds-button_neutral" onclick="backToList()" aria-label="Voltar para lista de leads">Voltar (Teste)</button></li>
                                    </ul>
                                </runtime_platform_actions-actions-ribbon>
                            </div>
                        </div>
                    </div>
                </records-lwc-highlights-panel>

                <div class="slds-grid slds-wrap slds-col slds-size_1-of-1 row row-main column">
                    <div class="slds-col slds-size_1-of-1 region-main region-full-width">
                        <div class="slds-card slds-card_boundary">
                            <div class="slds-tabs_default">
                                <ul class="slds-tabs_default__nav" role="tablist">
                                    <li class="slds-tabs_default__item slds-is-active" title="Detalhes" role="presentation"><a class="slds-tabs_default__link" href="javascript:void(0);" role="tab">Detalhes</a></li>
                                </ul>
                                <div class="slds-tabs_default__content slds-show" role="tabpanel">
                                    <records-lwc-detail-panel>
                                        <div class="slds-clearfix detail-panel-root slds-card">
                                            <div class="base-record-form-header-container slds-card__body slds-card__body_inner">
                                                <div class="record-body-container">
                                                    <records-lwc-record-layout>
                                                        <forcegenerated-detailpanel_leadindication id="detail-container">
                                                            </forcegenerated-detailpanel_leadindication>
                                                    </records-lwc-record-layout>
                                                </div>
                                            </div>
                                        </div>
                                    </records-lwc-detail-panel>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
            </div> </div> </div> <script>
        // ========================================
        // SISTEMA DE AUTENTICA√á√ÉO
        // ========================================
        const AUTH_KEY = 'salesforce_session_token';
        const AUTH_TIMESTAMP_KEY = 'salesforce_auth_timestamp';
        const AUTH_TIMEOUT = 3600000; // 1 hora em ms
        
        // Credenciais de teste (em produ√ß√£o, usar backend)
        const VALID_CREDENTIALS = {
            username: 'admin',
            password: '123456'
        };
        
        function generateToken() {
            return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function isAuthenticated() {
            // CORRE√á√ÉO PARA BOT: Em modo file://, usar APENAS localStorage (compartilhado entre abas)
            // No Salesforce real, os cookies HTTP fazem esse papel
            const isFileProtocol = window.location.protocol === 'file:';
            let token, timestamp;

            if (isFileProtocol) {
                // MODO FILE:// - Simular cookies compartilhados com localStorage
                token = localStorage.getItem(AUTH_KEY);
                timestamp = localStorage.getItem(AUTH_TIMESTAMP_KEY);
                console.log('ü§ñ Modo file:// - usando localStorage como cookies compartilhados');
            } else {
                // MODO HTTPS - Comportamento normal com sessionStorage + fallback
                token = sessionStorage.getItem(AUTH_KEY);
                timestamp = sessionStorage.getItem(AUTH_TIMESTAMP_KEY);

                if (!token) {
                    token = localStorage.getItem(AUTH_KEY);
                    timestamp = localStorage.getItem(AUTH_TIMESTAMP_KEY);
                    if (token && timestamp) {
                        console.log('üîÑ Sess√£o recuperada de outra aba (localStorage)');
                        sessionStorage.setItem(AUTH_KEY, token);
                        sessionStorage.setItem(AUTH_TIMESTAMP_KEY, timestamp);
                    }
                }
            }

            if (!token || !timestamp) {
                return false;
            }

            // Verificar se token expirou
            const elapsed = Date.now() - parseInt(timestamp);
            if (elapsed > AUTH_TIMEOUT) {
                sessionStorage.removeItem(AUTH_KEY);
                sessionStorage.removeItem(AUTH_TIMESTAMP_KEY);
                localStorage.removeItem(AUTH_KEY);
                localStorage.removeItem(AUTH_TIMESTAMP_KEY);
                return false;
            }

            return true;
        }
        
        function authenticate(username, password) {
            if (username === VALID_CREDENTIALS.username &&
                password === VALID_CREDENTIALS.password) {
                const token = generateToken();
                const timestamp = Date.now().toString();

                // SEMPRE salvar no localStorage (compartilhado entre abas)
                localStorage.setItem(AUTH_KEY, token);
                localStorage.setItem(AUTH_TIMESTAMP_KEY, timestamp);

                // sessionStorage s√≥ em modo HTTPS (em file:// n√£o √© necess√°rio)
                if (window.location.protocol !== 'file:') {
                    sessionStorage.setItem(AUTH_KEY, token);
                    sessionStorage.setItem(AUTH_TIMESTAMP_KEY, timestamp);
                }

                console.log('‚úÖ Token salvo em localStorage (compartilhado entre abas)');
                return true;
            }
            return false;
        }
        
        function checkAuthAndRender() {
            const loginScreen = document.getElementById('login-screen');
            const appContent = document.querySelector('.app-content');
            
            if (isAuthenticated()) {
                // Usu√°rio autenticado - mostrar aplica√ß√£o
                loginScreen.classList.add('hidden');
                appContent.classList.add('authenticated');
                console.log('‚úÖ Autentica√ß√£o v√°lida - acesso liberado');
            } else {
                // N√£o autenticado - mostrar tela de login
                loginScreen.classList.remove('hidden');
                appContent.classList.remove('authenticated');
                console.log('üö´ Sem autentica√ß√£o - acesso bloqueado');
            }
        }
        
        function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');

            if (authenticate(username, password)) {
                errorDiv.classList.add('hidden');
                console.log('‚úÖ Login bem-sucedido');
                checkAuthAndRender();

                // Inicializar dados ap√≥s login
                if (typeof initData === 'function') {
                    initData();
                }

                // Configurar scroll infinito (CR√çTICO: precisa ser ap√≥s o DOM estar vis√≠vel)
                setTimeout(() => {
                    setupInfiniteScroll();
                    startTimestampUpdates();
                    renderAllSubTabs();
                }, 100);
            } else {
                errorDiv.textContent = 'Usu√°rio ou senha inv√°lidos';
                errorDiv.classList.remove('hidden');
                console.log('‚ùå Login falhou');
            }
        }

        function logout() {
            // Limpar todos os tokens
            sessionStorage.removeItem(AUTH_KEY);
            sessionStorage.removeItem(AUTH_TIMESTAMP_KEY);
            localStorage.removeItem(AUTH_KEY);
            localStorage.removeItem(AUTH_TIMESTAMP_KEY);

            console.log('üö™ Logout realizado');

            // Voltar para tela de login
            checkAuthAndRender();
        }
        
        // ========================================
        // === SISTEMA DE ABAS COMPARTILHADO (localStorage + BroadcastChannel) ===
        const STORAGE_KEY = 'salesforce_open_tabs';
        const CHANNEL_NAME = 'salesforce_tabs_sync';
        let tabChannel = null;
        let localActiveTab = null; // Qual aba est√° ativa NESTA janela
        
        // Inicializar BroadcastChannel (para comunica√ß√£o em tempo real entre abas)
        try {
            tabChannel = new BroadcastChannel(CHANNEL_NAME);
            tabChannel.onmessage = (event) => {
                handleTabSync(event.data);
            };
        } catch (e) {
            console.log('BroadcastChannel n√£o suportado, usando apenas localStorage');
        }
        
        // Fallback: escutar mudan√ßas no localStorage
        // DESABILITADO: Causava re-render durante descarte, fazendo abas sumirem/aparecerem
        // window.addEventListener('storage', (event) => {
        //     if (event.key === STORAGE_KEY) {
        //         renderAllSubTabs();
        //     }
        // });
        
        // === FUN√á√ïES DE ESTADO COMPARTILHADO ===
        function loadSharedTabs() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                return [];
            }
        }
        
        function saveSharedTabs(tabs) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(tabs));
            } catch (e) {
                console.error('Erro ao salvar tabs:', e);
            }
        }
        
        function broadcastTabChange(action, leadId) {
            if (tabChannel) {
                tabChannel.postMessage({ action, leadId, timestamp: Date.now() });
            }
        }
        
        function handleTabSync(data) {
            // Recebeu notifica√ß√£o de outra aba
            // DESABILITADO: Causava re-render durante descarte
            // renderAllSubTabs();
        }
        
        // === FUN√á√ïES DE UI DAS ABAS ===
        function addLeadSubTab(leadId, leadName) {
            // Carregar estado compartilhado
            let sharedTabs = loadSharedTabs();
            
            // Verificar se j√° existe
            if (!sharedTabs.includes(leadId)) {
                sharedTabs.push(leadId);
                saveSharedTabs(sharedTabs);
                broadcastTabChange('add', leadId);
            }
            
            // Renderizar todas as abas (incluindo a nova)
            renderAllSubTabs();
            
            // Ativar esta aba localmente
            activateSubTab(leadId);
        }
        
        function renderAllSubTabs() {
            const sharedTabs = loadSharedTabs();
            const subTabList = document.getElementById('sub-tab-list');
            
            // Remover todas as abas de lead (manter apenas a aba "list")
            subTabList.querySelectorAll('.slds-sub-tabs__item:not([data-tab-id="list"])').forEach(tab => {
                tab.remove();
            });
            
            // Adicionar abas do estado compartilhado
            sharedTabs.forEach(leadId => {
                const existingTab = subTabList.querySelector(`[data-tab-id="${leadId}"]`);
                if (!existingTab) {
                    const newTab = document.createElement('li');
                    newTab.className = 'slds-sub-tabs__item';
                    newTab.setAttribute('data-tab-id', leadId);
                    newTab.innerHTML = `
                        <a class="tabHeader" href="javascript:void(0);" role="tab" onclick="activateSubTab('${leadId}')">
                            <span class="subtab-icon">
                                <svg class="slds-icon slds-icon_x-small" aria-hidden="true" style="width: 14px; height: 14px; fill: currentColor;">
                                    <use xlink:href="https://cdnjs.cloudflare.com/ajax/libs/design-system/2.21.0/icons/utility-sprite/svg/symbols.svg#user"></use>
                                </svg>
                            </span>
                            <span class="title">${leadId}</span>
                        </a>
                        <button class="close-btn" onclick="closeLeadTab('${leadId}'); event.stopPropagation();" title="Fechar">‚úï</button>
                    `;
                    subTabList.appendChild(newTab);
                }
            });
            
            // Manter a aba ativa desta janela
            if (localActiveTab) {
                highlightActiveTab(localActiveTab);
            }
        }
        
        function highlightActiveTab(tabId) {
            // Remover active de todas as sub-tabs
            document.querySelectorAll('.slds-sub-tabs__item').forEach(tab => {
                tab.classList.remove('slds-is-active');
            });
            
            // Adicionar active na aba selecionada
            const selectedTab = document.querySelector(`.slds-sub-tabs__item[data-tab-id="${tabId}"]`);
            if (selectedTab) {
                selectedTab.classList.add('slds-is-active');
            }
        }
        
        function activateSubTab(tabId) {
            localActiveTab = tabId;
            highlightActiveTab(tabId);
            
            // Mostrar view correspondente
            if (tabId === 'list') {
                document.getElementById('view-list').classList.remove('hidden');
                document.getElementById('view-detail').classList.add('hidden');
            } else {
                document.getElementById('view-list').classList.add('hidden');
                document.getElementById('view-detail').classList.remove('hidden');
            }
        }
        
        function switchToList() {
            activateSubTab('list');
            // CORRE√á√ÉO CR√çTICA PARA O BOT:
            // Limpa a hash (#LI-XXX) da URL para que futuras navega√ß√µes sejam detectadas
            history.pushState("", document.title, window.location.pathname + window.location.search);
        }
        
        function closeLeadTab(leadId) {
            // Remover do estado compartilhado
            let sharedTabs = loadSharedTabs();
            sharedTabs = sharedTabs.filter(id => id !== leadId);
            saveSharedTabs(sharedTabs);
            broadcastTabChange('remove', leadId);

            // Atualizar UI - Remover apenas a aba espec√≠fica (SEM re-render total)
            const tabElement = document.querySelector(`.slds-sub-tabs__item[data-tab-id="${leadId}"]`);
            if (tabElement) {
                tabElement.remove();
            }

            // Se estava visualizando este lead nesta janela, voltar para lista
            if (currentLeadId === leadId || localActiveTab === leadId) {
                currentLeadId = null;
                switchToList();
            }
        }
        
        // Limpar abas ao iniciar nova sess√£o (opcional - descomentar se quiser)
        // function clearAllTabs() {
        //     localStorage.removeItem(STORAGE_KEY);
        //     renderAllSubTabs();
        // }
        // === GERA√á√ÉO DE DADOS MOCK ===
        const leads = [];

        // Helper: Criar badge colorido para status
        function getStatusBadge(status) {
            const statusColors = {
                'Novo': { bg: '#e8f4e8', color: '#027e46' },
                'Em Andamento': { bg: '#fef3d9', color: '#826800' },
                'Descartado': { bg: '#feded8', color: '#ba0517' }
            };
            const colors = statusColors[status] || { bg: '#e0e5ee', color: '#3e3e3c' };
            return `<span class="slds-badge slds-badge_lightest" style="background:${colors.bg}; color:${colors.color}; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">${status}</span>`;
        }

        function initData() {
            // PROTE√á√ÉO: N√£o carregar dados sem autentica√ß√£o
            if (!isAuthenticated()) {
                console.warn('‚ö†Ô∏è Tentativa de carregar dados sem autentica√ß√£o - BLOQUEADO');
                return;
            }
            
            const firstNames = ["Filipe", "Marcos", "Ana", "Carlos", "Beatriz", "Jo√£o", "Mariana", "Pedro", "Luiza", "Gabriel"];
            const lastNames = ["Souza", "Silva", "Oliveira", "Santos", "Lima", "Pereira", "Costa", "Rodrigues", "Almeida", "Nascimento"];
            const cities = ["Belo Horizonte", "S√£o Paulo", "Rio de Janeiro", "Curitiba", "Bras√≠lia"];
            const profiles = ["AAI Junior", "AAI Pleno", "AAI Senior"];
            const contracts = ["CLT", "PJ"];
            const professions = ["Analista Financeiro", "Consultor de Investimentos", "Gerente Comercial", "Analista de Mercado"];
            const feedbacks = [
                "Candidato demonstrou interesse e conhecimento do mercado",
                "Possui experi√™ncia pr√©via com vendas e relacionamento com clientes",
                "Perfil alinhado com valores da empresa",
                "Boa comunica√ß√£o e proatividade demonstradas na entrevista"
            ];

            for(let i=0; i<150; i++) {
                const firstName = firstNames[i%10];
                const lastName = lastNames[i%10];
                const name = `${firstName} ${lastName} ${i}`;
                const id = `LI-00${183932 + i}`;
                const age = 22 + (i%30);
                const progress = Math.floor(Math.random() * 100);

                // Datas futuras realistas
                const hireDate = new Date(2026, 0, 15 + (i % 20));
                const hireDateStr = hireDate.toLocaleDateString('pt-BR');

                leads.push({
                    id: id,
                    name: name,
                    email: `${firstName.toLowerCase()}.${lastName.toLowerCase()}${i}@gmail.com`,
                    phone: `(31) 9${String(8000 + i).padStart(4, '0')}-${String(1000 + (i * 13) % 9000).padStart(4, '0')}`,
                    age: age,
                    location: cities[i%5],
                    status: i < 10 ? "Novo" : "Em Andamento",
                    ancordProgress: progress,
                    ancordProgressFormatted: `${progress}%`,
                    indicationDate: "02/12/2025",
                    profile: profiles[i % 3],
                    contractType: contracts[i % 2],
                    hireDate: hireDateStr,
                    profession: professions[i % 4],
                    linkedin: `https://linkedin.com/in/${firstName.toLowerCase()}-${lastName.toLowerCase()}-${i}`,
                    feedback: feedbacks[i % 4],
                    contactAttempt: `${(i % 3) + 1}¬™ tentativa`
                });
            }
            renderList();
        }

        // === SIMULA√á√ÉO DE REDE ===
        function showSpinner() { document.getElementById('loading-spinner').classList.remove('hidden'); }
        function hideSpinner() { document.getElementById('loading-spinner').classList.add('hidden'); }

        function showToast(type, msg) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `slds-notify slds-notify_toast slds-theme_${type}`;
            toast.innerHTML = `<div class="slds-notify__content"><h2 class="slds-text-heading_small">${msg}</h2></div>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function simulateNetwork(actionName, callback) {
            showSpinner();

            // Delays realistas por tipo de opera√ß√£o (igual ao Salesforce real)
            const delays = {
                'Carregando Lead': [800, 2000],      // Leitura: 0.8-2s
                'Salvando...': [1200, 3500],         // Escrita: 1.2-3.5s
                'Abrindo Modal': [300, 800],         // UI: 0.3-0.8s
                'Pretendo Contratar': [1500, 4000]   // A√ß√£o complexa: 1.5-4s
            };

            const [min, max] = delays[actionName] || [500, 2500];
            const delay = Math.floor(Math.random() * (max - min)) + min;

            setTimeout(() => {
                hideSpinner();

                // 5% de chance de erro (para testar tratamento de falhas)
                if (Math.random() < 0.05) {
                    showToast('error', `Erro: ${actionName} falhou. Tente novamente.`);
                    console.error(`‚ùå Erro simulado na a√ß√£o: ${actionName}`);
                    return; // N√£o executa callback
                }

                if(callback) callback();
                else showToast('success', `${actionName} realizado com sucesso.`);
            }, delay);
        }

        // === RENDERIZA√á√ÉO DA LISTA (COM SCROLL INFINITO) ===
        let currentPage = 0;
        const PAGE_SIZE = 25;

        function renderList(append = false) {
            const tbody = document.getElementById('list-table-body');

            if (!append) {
                tbody.innerHTML = '';
                currentPage = 0;
            }

            const start = currentPage * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pageLeads = leads.slice(start, end);

            pageLeads.forEach((l, relativeIdx) => {
                const idx = start + relativeIdx;
                const tr = document.createElement('tr');
                tr.className = 'slds-hint-parent';
                tr.innerHTML = `
                    <td>${idx+1}</td>
                    <th data-label="Meus Leads"><a href="#${l.id}" onclick="openLead('${l.id}'); return false;" data-record-id="${l.id}" aria-label="Abrir lead ${l.id}">${l.id}</a></th>
                    <td>${l.name}</td>
                    <td id="list-status-${l.id}" data-status="${l.status}">${getStatusBadge(l.status)}</td>
                    <td>${l.location}</td>
                `;
                tr.setAttribute('data-row-key-value', l.id);
                tr.setAttribute('aria-label', `Lead ${l.name}`);
                tbody.appendChild(tr);
            });

            currentPage++;
        }

        // Listener de scroll infinito
        function setupInfiniteScroll() {
            // O scroll real est√° no .slds-scrollable_y, n√£o no container pai
            const scrollContainer = document.querySelector('.slds-scrollable_y');
            if (!scrollContainer) {
                console.warn('‚ö†Ô∏è Container de scroll n√£o encontrado');
                return;
            }

            scrollContainer.addEventListener('scroll', (e) => {
                const el = e.target;
                // Detectar se chegou perto do fim (100px antes)
                if (el.scrollHeight - el.scrollTop <= el.clientHeight + 100) {
                    // Se ainda tem mais leads para carregar
                    if (currentPage * PAGE_SIZE < leads.length) {
                        console.log(`üìú Carregando mais leads (p√°gina ${currentPage + 1})...`);
                        renderList(true); // Append
                    }
                }
            });

            console.log('‚úÖ Scroll infinito configurado');
        }

        // Timestamp din√¢mico que atualiza automaticamente
        function updateTimestamp() {
            const timestampEl = document.querySelector('.slds-text-body--small');
            if (timestampEl) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                timestampEl.textContent = `150 itens ‚Ä¢ Atualizado √†s ${timeStr}`;
            }
        }

        function startTimestampUpdates() {
            // Atualizar imediatamente
            updateTimestamp();

            // Atualizar a cada 30 segundos
            setInterval(updateTimestamp, 30000);
        }

        // === RENDERIZA√á√ÉO DO DETALHE (EXTREMAMENTE FIEL AO LORO 2) ===
        let currentLeadId = null;

        // Helper: Renderizar HTML do detalhe do lead (usado por openLead e openLeadDirect)
        function renderLeadDetails(lead) {
            return `
                <records-record-layout-block>
                    ${buildSection("Informa√ß√µes do Lead", [
                        buildRow("Nome do candidato", lead.name, "Perfil", lead.profile),
                        buildRow("E-mail do candidato", `<a href="mailto:${lead.email}">${lead.email}</a>`, "Idade", lead.age),
                        buildRow("Telefone do candidato", `<a href="tel:${lead.phone}">${lead.phone}</a>`, "Localiza√ß√£o", lead.location),
                        buildRow("Tipo de Contrato", lead.contractType, "Data da Contrata√ß√£o", lead.hireDate),
                        buildRow("Status do Lead", `<span id="detail-status">${getStatusBadge(lead.status)}</span>`, "Possui v√≠nculo com a Concorr√™ncia?", "false"),
                        buildRow("Em qual oportunidade gostaria de atuar", "Assessor de Investimentos", "Profiss√£o", lead.profession),
                        buildRow("Forma√ß√£o Acad√™mica", "Superior Completo", "Linkedin", `<a href="${lead.linkedin}" target="_blank">${lead.linkedin}</a>`),
                        buildRow("Descri√ß√£o", "", "", "")
                    ])}

                    ${buildSection("Informa√ß√µes de Feedback", [
                        buildRow("Feedback geral", lead.feedback, "", "")
                    ])}

                    ${buildSection("Informa√ß√µes de Status", [
                        buildRow("Status", lead.status, "Tentativa de contato", lead.contactAttempt),
                        buildRow("Motivo do descarte", "", "Detalhe do motivo", ""),
                        buildRow("Descri√ß√£o do motivo de descarte", "", "", "")
                    ])}

                    ${buildSection("Informa√ß√µes do Caso", [
                        buildRow("N√∫mero do Caso", "", "Etapa do Caso", ""),
                        buildRow("Assunto do Caso", "", "Status do Caso", "")
                    ])}

                    ${buildSection("Informa√ß√µes da Certifica√ß√£o", [
                        buildRow("Progresso Curso Preparat√≥rio Ancord", lead.ancordProgressFormatted, "Aprovado na ANCORD", "false"),
                        buildRow("Envio Curso Preparat√≥rio Ancord", "", "Situa√ß√£o Ancord", ""),
                        buildRow("Certifica√ß√£o Adicional", "", "Data da Certifica√ß√£o", "")
                    ])}

                    ${buildSection("Informa√ß√µes de prazo", [
                        buildRow("Meus Leads", lead.id, "Data de Indica√ß√£o", lead.indicationDate),
                        buildRow("Prazo para vincular", "", "N√∫mero do caso", ""),
                        buildRow("Data de expira√ß√£o para v√≠nculo", "", "Solicita√ß√£o de Lead", "<a href='#'>SL-9021</a>"),
                        buildRow("Prazo para demostrar interesse", "19", "Propriet√°rio", "<a href='#'>Integra√ß√£o Growth</a>"),
                        buildRow("Data expira√ß√£o para demostrar interesse", "23/12/2025", "Sem√°foro", '<img src="/img/samples/light_green.gif" alt="Verde" border="0">')
                    ])}

                    ${buildSection("Informa√ß√µes do Escrit√≥rio", [
                        buildRow("Nome do escrit√≥rio", "PLT Investimentos", "C√≥digo do escrit√≥rio", "70004")
                    ])}

                    ${buildSection("Informa√ß√µes do Sistema", [
                        buildRow("Criado por", "<a href='#'>Integra√ß√£o Growth</a>, 02/12/2025", "", "")
                    ])}
                </records-record-layout-block>
            `;
        }

        function openLead(id) {
            // PROTE√á√ÉO: Verificar autentica√ß√£o
            if (!isAuthenticated()) {
                showToast('error', 'Sess√£o expirada. Fa√ßa login novamente.');
                checkAuthAndRender();
                return;
            }

            // Criar sub-aba imediatamente
            const lead = leads.find(l => l.id === id);
            addLeadSubTab(id, lead.name);

            // Trocar para view de detalhe e mostrar skeleton loading
            document.getElementById('view-list').classList.add('hidden');
            document.getElementById('view-detail').classList.remove('hidden');
            document.getElementById('header-lead-id').innerText = id;

            // Mostrar skeleton screen enquanto carrega
            const container = document.getElementById('detail-container');
            container.innerHTML = `
                <div class="slds-is-relative" style="min-height: 400px; padding: 2rem;">
                    <div role="status" class="slds-spinner slds-spinner_medium slds-spinner_brand">
                        <span class="slds-assistive-text">Carregando detalhes do lead...</span>
                        <div class="slds-spinner__dot-a"></div>
                        <div class="slds-spinner__dot-b"></div>
                    </div>
                </div>
            `;

            simulateNetwork("Carregando Lead", () => {
                currentLeadId = id;
                const container = document.getElementById('detail-container');
                container.innerHTML = renderLeadDetails(lead);
            });
        }

        // Fun√ß√µes auxiliares para gerar HTML sujo do Salesforce
        function buildSection(title, rows) {
            return `
            <records-record-layout-section>
                <div class="test-id__section slds-section has-header slds-is-open slds-m-vertical_none">
                    <h3 class="test-id__section-header-container slds-section__title">
                        <button class="test-id__section-header-button slds-section__title-action slds-button">
                            <span class="test-id__section-header-title">${title}</span>
                        </button>
                    </h3>
                    <div class="test-id__section-content slds-section__content">
                        <div class="slds-form" role="list">${rows.join('')}</div>
                    </div>
                </div>
            </records-record-layout-section>`;
        }

        function buildRow(label1, val1, label2, val2) {
            return `
            <records-record-layout-row class="slds-form__row">
                <div class="slds-grid slds-size_1-of-1">
                    ${buildItem(label1, val1)}
                    ${label2 ? buildItem(label2, val2) : ''}
                </div>
            </records-record-layout-row>`;
        }

        function buildItem(label, value) {
            return `
            <records-record-layout-item class="slds-form__item slds-no-space slds-size_1-of-2" field-label="${label}">
                <div class="slds-grid slds-size_1-of-1 label-inline">
                    <div class="slds-form-element slds-hint-parent test-id__output-root slds-form-element_readonly slds-form-element_horizontal">
                        <div class="test-id__field-label-container slds-form-element__label">
                            <span class="test-id__field-label">${label}</span>
                        </div>
                        <div class="slds-form-element__control">
                            <span class="test-id__field-value slds-form-element__static slds-grow">
                                <lightning-formatted-text>${value}</lightning-formatted-text>
                            </span>
                        </div>
                    </div>
                </div>
            </records-record-layout-item>`;
        }

        function backToList() {
            // Fecha a aba atual e volta para lista
            if (currentLeadId) {
                closeLeadTab(currentLeadId);
            } else {
                switchToList();
            }
        }

        // === L√ìGICA DO MODAL ===
        function openDiscardModal() {
            simulateNetwork("Abrindo Modal", () => {
                document.getElementById('modal-discard').classList.remove('hidden');
                document.getElementById('discard-trigger').innerText = "-- Nenhum --";
            });
        }

        function closeModal() { document.getElementById('modal-discard').classList.add('hidden'); }

        function toggleDropdown(id) {
            const el = document.getElementById(id);
            document.querySelectorAll('.uiMenuList').forEach(m => { if(m.id!==id) m.classList.remove('visible'); });
            el.classList.toggle('visible');
        }

        function selectOption(triggerId, listId, val) {
            document.getElementById(triggerId).innerText = val;
            document.getElementById(listId).classList.remove('visible');
        }

        function saveDiscard() {
            const trigger = document.getElementById('discard-trigger');
            const reason = trigger.innerText;

            // Valida√ß√£o igual ao Salesforce real
            if(reason === "-- Nenhum --") {
                // Toast de erro
                showToast('error', 'Erro: Campo obrigat√≥rio "Motivo do descarte" n√£o foi preenchido.');

                // Feedback visual: borda vermelha
                trigger.style.borderColor = '#c23934';
                trigger.style.borderWidth = '2px';

                // Remover borda vermelha ap√≥s 3s
                setTimeout(() => {
                    trigger.style.borderColor = '';
                    trigger.style.borderWidth = '';
                }, 3000);

                return;
            }

            // Resetar borda se estava vermelha
            trigger.style.borderColor = '';
            trigger.style.borderWidth = '';

            simulateNetwork("Salvando...", () => {
                closeModal();
                const lead = leads.find(l => l.id === currentLeadId);
                if(lead) {
                    lead.status = "Descartado";
                    document.getElementById('list-status-'+lead.id).innerHTML = getStatusBadge("Descartado");
                    document.getElementById('detail-status').innerHTML = getStatusBadge("Descartado");
                }
                showToast('success', 'Lead descartado.');
            });
        }

        // Handle leadId from URL on page load
        document.addEventListener('DOMContentLoaded', () => {
            // 1. INICIALIZAR SISTEMA DE AUTENTICA√á√ÉO (PRIMEIRO)
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            // 2. VERIFICAR AUTENTICA√á√ÉO
            checkAuthAndRender();
            
            // 3. SE AUTENTICADO, INICIALIZAR DADOS E APP
            if (isAuthenticated()) {
                // Inicializar dados
                initData();

                // Configurar scroll infinito
                setupInfiniteScroll();

                // Iniciar atualiza√ß√£o de timestamps
                startTimestampUpdates();

                // Renderizar todas as abas j√° abertas (de outras janelas)
                renderAllSubTabs();
                
                const urlParams = new URLSearchParams(window.location.search);
                const leadIdQuery = urlParams.get('leadId');
                // Suporte tamb√©m para hash (ex: teste.html#LI-123456) usado pelo bot
                const leadIdHash = window.location.hash ? window.location.hash.substring(1) : null;
                
                const leadId = leadIdQuery || leadIdHash;
                
                if (leadId) {
                    // Bot navegou direto para o lead
                    openLeadDirect(leadId);
                } else {
                    // Navega√ß√£o normal - ativar aba "Lista"
                    activateSubTab('list');
                }
            }
        });
        
        // Fun√ß√£o para abrir lead diretamente (usado quando bot navega por URL)
        function openLeadDirect(id) {
            // PROTE√á√ÉO: Verificar autentica√ß√£o
            if (!isAuthenticated()) {
                console.error('‚ùå Tentativa de acesso direto sem autentica√ß√£o - BLOQUEADO');
                checkAuthAndRender();
                return;
            }
            
            currentLeadId = id;
            const lead = leads.find(l => l.id === id);
            if (!lead) return;
            
            // Criar sub-aba para este lead
            addLeadSubTab(id, lead.name);
            
            document.getElementById('view-list').classList.add('hidden');
            document.getElementById('view-detail').classList.remove('hidden');
            document.getElementById('header-lead-id').innerText = lead.id;

            // Renderizar detalhes imediatamente (sem delay)
            const container = document.getElementById('detail-container');
            container.innerHTML = renderLeadDetails(lead);
        }

        // =================================================================
    // ATUALIZA√á√ÉO PARA SUPORTAR BOT "SINGLE TAB" (MESMA ABA)
    // =================================================================
    
    // Isso detecta quando o bot muda a URL (ex: #LI-001) sem recarregar a p√°gina
    window.addEventListener('hashchange', function() {
        const leadIdHash = window.location.hash ? window.location.hash.substring(1) : null;
        if (leadIdHash) {
            console.log("Bot navegou para:", leadIdHash);
            openLeadDirect(leadIdHash);
        }
    });

    // Garante que o scroll da tabela funcione bem
    window.addEventListener('load', function() {
        console.log("Sistema pronto para automa√ß√£o Single Tab");
    });
    </script>
</body>
</html>